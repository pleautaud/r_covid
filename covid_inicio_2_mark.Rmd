---
title: "Análisis datos SARS-CoV2 reportados oficialmente en México"
author:
- P. Leautaud-Valenzuela
- contacto@pablo-leautaud.com
date: "Compilado el: `r format(Sys.time(), '%Y/%m/%d')`"
output:
  html_document:
    theme: sandstone
    fig_caption: true
    toc: true
    toc_depth: 4
    toc_float: true
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introducción
Este documento presenta un análisis en lenguaje *R* de los datos abiertos referentes a los casos de SARS-CoV2 (también conocido como COVID-19), reportados por la Dirección General de Epidemiología de la Secretaría de Salud del Gobierno Federal de México, y los cuales pueden ser descargados del portal de [datos abiertos](https://www.gob.mx/salud/documentos/datos-abiertos-152127).

### Paquetes necesarios para el script:
```{r eval=TRUE, results='hide', message=FALSE, warning=FALSE}
library(markdown)
library(hashmap)
library(lubridate)
library(dplyr)
library(summarytools)
library(tidyr)
library(ggpubr)
library(knitr)
library(kableExtra)
library(reshape2)
library(sf)
library(tmap)
```

### Semilla para valores aleatorios.
Dado que valores aleatorios son requeridos en algunos procesos de R, se fija un número de semilla con fines de replicabilidad de los análisis.
```{r eval=TRUE}
set.seed(42)
```

### Importación de los datos:
Se incorporan los datos descargados del portal de datos abiertos, los cuales consisten en un archivo delimitado por comas empleando la codificación unicode UTF-8
```{r eval=TRUE}
datos <- read.csv("200511COVID19MEXICO.csv", header = TRUE, encoding = "UTF-8")
datos2 <- datos
datos2$Num <- 1
```

### Creación de los diccionarios:
La tabla que originalmente se descarga integra los valores de cada variable mediante una codificación definida por los catálogos y diccionario de datos que también se puede encontrar en el [portal datos abiertos](https://www.gob.mx/salud/documentos/datos-abiertos-152127).
```{r eval=TRUE}
d_origen <- hashmap(c(1,2,99), c("USMER","Fuera USMER","No especificado"))
d_sector <- hashmap(c(1,2,3,4,5,6,7,8,9,10,11,12,13,99), 
                    c("CRUZ ROJA","DIF","ESTATAL","IMSS","IMSS-BIENESTAR","ISSSTE","MUNICIPAL","PEMEX",
                       "PRIVADA","SEDENA","SEMAR","SSA","UNIVERSITARIO","NO ESPECIFICADO"))
d_sexo <- hashmap(c(1,2,99), c("MUJER","HOMBRE","NO ESPECIFICADO"))
d_tipo <- hashmap(c(1,2,99), c("AMBULATORIO","HOSPITALIZADO","NO ESPECIFICADO"))
d_si_no <- hashmap(c(1,2,97,98,99), c("SI","NO","NO APLICA","SE IGNORA","NO ESPECIFICADO"))
d_nacion <- hashmap(c(1,2,99), c("MEXICANA","EXTRANJERA","NO ESPECIFICADO"))
d_resultado <- hashmap(c("1","2","3"),c("Positivo SARS-CoV-2","No positivo SARS-CoV-2","Resultado pendiente"))
d_entidad <- hashmap(c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,
                       36,97,98,99),
                     c("AGU","BCN","BCS","CAM","COA","COL","CHP","CHH","CMX","DUR","GUA","GRO","HID","JAL",
                       "MEX","MIC","MOR","NAY","NLE","OAX","PUE","QUE","ROO","SLP","SIN","SON","TAB","TAM",
                       "TLA","VER","YUC","ZAC","EUM","N_A","S_I","N_E"))
```

### Preparación de la tabla
Con base en los diccionarios definidos en la sección anterior, se procesan los datos de la tabla original para transformar los valores codificados en su nombres legibles, aprovechando para definir a las variables categóricas como factores.

Durante este documento se retomaran los nombres originales de las variables, cuando se de este caso se reportan estos nombres *[dentro de corchetes y en itálicas]*.

El primer paso consiste en integrar los identificadores de las entidades federativas y los municipios, para obtener una clave geoestadística compatible con la información del Instituto Nacional de Estadística y Geografía (INEGI):
```{r eval=TRUE}
datos2$MUNICIPIO_RES <- paste(sprintf("%02d", datos2$ENTIDAD_RES), sprintf("%03d", datos2$MUNICIPIO_RES))
datos2$MUNICIPIO_RES <- as.factor(gsub("[[:space:]]", "", datos2$MUNICIPIO_RES))
```

El siguiente paso es la decodificación con base en los diccionarios definidos:
```{r eval=TRUE}
datos2$ORIGEN <- as.factor(d_origen[[datos2$ORIGEN]])
datos2$SECTOR <- as.factor(d_sector[[datos2$SECTOR]])
datos2$ENTIDAD_UM <- as.factor(d_entidad[[datos2$ENTIDAD_UM]])
datos2$SEXO <- as.factor(d_sexo[[datos2$SEXO]])
datos2$ENTIDAD_NAC <- as.factor(d_entidad[[datos2$ENTIDAD_NAC]])
datos2$ENTIDAD_RES <- as.factor(d_entidad[[datos2$ENTIDAD_RES]])
datos2$TIPO_PACIENTE  <- as.factor(d_tipo[[datos2$TIPO_PACIENTE]])
datos2$INTUBADO <- as.factor(d_si_no[[datos2$INTUBADO]])
datos2$NEUMONIA <- as.factor(d_si_no[[datos2$NEUMONIA]])
datos2$NACIONALIDAD <- as.factor(d_nacion[[datos2$NACIONALIDAD]])
datos2$EMBARAZO <- as.factor(d_si_no[[datos2$EMBARAZO]])
datos2$HABLA_LENGUA_INDIG <- as.factor(d_si_no[[datos2$HABLA_LENGUA_INDIG]])
datos2$DIABETES <- as.factor(d_si_no[[datos2$DIABETES]])
datos2$EPOC <- as.factor(d_si_no[[datos2$EPOC]])
datos2$ASMA <- as.factor(d_si_no[[datos2$ASMA]])
datos2$INMUSUPR <- as.factor(d_si_no[[datos2$INMUSUPR]])
datos2$HIPERTENSION <- as.factor(d_si_no[[datos2$HIPERTENSION]])
datos2$OTRA_COM <- as.factor(d_si_no[[datos2$OTRA_COM]])
datos2$CARDIOVASCULAR <- as.factor(d_si_no[[datos2$CARDIOVASCULAR]])
datos2$OBESIDAD <- as.factor(d_si_no[[datos2$OBESIDAD]])
datos2$RENAL_CRONICA <- as.factor(d_si_no[[datos2$RENAL_CRONICA]])
datos2$TABAQUISMO <- as.factor(d_si_no[[datos2$TABAQUISMO]])
datos2$OTRO_CASO <- as.factor(d_si_no[[datos2$OTRO_CASO]])
datos2$RESULTADO <- as.factor(d_resultado[[datos2$RESULTADO]])
datos2$MIGRANTE <- as.factor(d_si_no[[datos2$MIGRANTE]])
datos2$UCI <- as.factor(d_si_no[[datos2$UCI]])

levels(datos2$PAIS_NACIONALIDAD) <- c(levels(datos2$PAIS_NACIONALIDAD), "Se ignora")
datos2$PAIS_NACIONALIDAD[datos2$PAIS_NACIONALIDAD == 99] <- "Se ignora"
levels(datos2$PAIS_ORIGEN) <- c(levels(datos2$PAIS_ORIGEN), "No aplica")
datos2$PAIS_ORIGEN[datos2$PAIS_ORIGEN == 97] <- "No aplica"
```

Del mismo modo se asigna el formato de fecha a las variables que así lo requieren:
```{r eval=TRUE}
datos$FECHA_ACTUALIZACION <- ymd(datos$FECHA_ACTUALIZACION)
datos2$FECHA_INGRESO <- ymd(datos2$FECHA_INGRESO)
datos2$FECHA_SINTOMAS <- ymd(datos2$FECHA_SINTOMAS)
datos2$FECHA_DEF <- na_if(datos2$FECHA_DEF,"9999-99-99")
datos2$FECHA_DEF <- ymd(datos2$FECHA_DEF)
```

Finalmente, se exporta la tabla procesada en un formato compatible con otros programas gestores de datos o de análisis estadístico:
```{r eval=TRUE}
write.csv(datos2, file = "tabla_procesada.csv")
```

### Estadística descriptiva
En la siguiente tabla se reportan los parámetros estadísticos básicos para todas las variables que componen la tabla de datos procesada:
```{r eval=TRUE}
print(dfSummary(datos2, graph.magnif = 0.75, valid.col = FALSE, na.col = FALSE, 
      max.distinct.values = 5, headings = FALSE),method = 'render')
```

# Análisis de los datos  
Como primer paso debemos establecer cuantos de los registros presentaron un resultado con un diagnostico positivo ante SARS-Cov2, para lo cual temamos las categorías delimitadas por el factor *[RESULTADO]*:  

* No positivo SARS-CoV-2  
* Positivo SARS-CoV-2  
* Resultado pendiente  

Obteniendo los resultados reportados en la siguiente tabla:
```{r results = 'asis'}
tab_resultado <- count(datos2, Resultado = datos2$RESULTADO)
tab_resultado["Porcentaje"] <- round(tab_resultado$n*100 / sum(tab_resultado$n),1)  
kable(tab_resultado, format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "center")
```

Y en la siguiente gráfica:
```{r eval=TRUE,fig1, fig.align = "center"}
tab_resultado_lab <- paste0(tab_resultado$Resultado, "\n (", tab_resultado$Porcentaje, "%)")
ggpie(tab_resultado, "Porcentaje", label = tab_resultado_lab,
      lab.pos = "in", lab.font = "black", lab.adjust = 0,
      fill = "Resultado", color = "white",
      palette = c("#C1D40E", "#FF9999", "#EAEAEA"))
```

Como se puede apreciar, **al día `r first(datos$FECHA_ACTUALIZACION)` se cuentan con `r format(tab_resultado$n[which(tab_resultado$Resultado == "Positivo SARS-CoV-2")],big.mark=",")` casos positivos ante SARS-CoV2**, en ese sentido, para continuar con el proceso de los datos se realiza una selección de variables retomando únicamente los casos positivos:
```{r eval=TRUE}
datos3 <- subset(datos2, RESULTADO == "Positivo SARS-CoV-2")
```

### Casos detectados por fecha
En las siguientes gráficas podemos apreciar el número de casos diagnosticado por día (A), así como el acumulado del periodo total (B), tomado como referencia la fecha de ingreso del paciente *[FECHA_INGRESO]*:
```{r eval=TRUE, fig2, fig.height = 5, fig.width = 10, fig.align = "center"}
tab_fecha_in <- count(datos3, Fecha = datos3$FECHA_INGRESO)
tab_fecha_in["Acumulado"] <- cumsum(tab_fecha_in$n)

g_sum <- ggbarplot(tab_fecha_in, x = "Fecha", y = "n",
                   fill = "steelblue", color = "black",)
g_acum <- ggline(tab_fecha_in, x = "Fecha", y = "Acumulado",
                 color = "steelblue", point.color = "black", point.size = 0.2) +
  scale_y_continuous(labels=function(x) format(x, big.mark = ",", scientific = FALSE))

ggarrange(g_sum, g_acum, labels = c("A)", "B)"), ncol = 2, nrow = 1)
```

#### Modelo de crecimiento logístico de casos detectados
Como se aprecia en la figura anterior (B), inicialmente se observa un crecimiento exponencial de los casos positivos detectados, sin embargo, como muchos otros procesos naturales, la propagación de enfermedades epidémicas suele seguir una función logística. Dicha función constituye un refinamiento del modelo exponencial para el crecimiento de una magnitud y modela la función sigmoidea de crecimiento de un conjunto.

Esta función se representa como: $Y = \frac{\phi_1}{1+e^{-1\cdot \left ( \phi_2 + \phi_3\cdot x \right )}}$  

Donde:  

* $Y$, es la población (u otra variable) sujeta a un crecimiento logístico.  
* $\phi_1$, es el primer parámetro *Phi*, el cual determina la asíntota de la curva.  
* $\phi_2$, es el segundo parámetro *Phi*.
* $\phi_3$, es el tercer parámetro *Phi*, el cual determina la velocidad del crecimiento.  
* $x$, es la variable de entrada, en este caso los días transcurridos desde la primer detección.  

En este sentido, se realiza un ajuste de los valores de casos positivos detectados a una función logística, para predecir los valores de casos positivos detectados en los próximos 45 días. Para tal efecto, se omiten los últimos tres días de registro, los cuales probablemente no cuenten con los valores de detección reales y tenga como efecto la formación de una falsa asíntota:
```{r eval=TRUE}
tab_fecha_in2 <- tab_fecha_in %>% mutate(Dif_dias = difftime(tab_fecha_in$Fecha, lag(tab_fecha_in$Fecha,1)))
tab_fecha_in2$Dif_dias <- replace_na(tab_fecha_in2$Dif_dias,1)
tab_fecha_in2$Dif_dias <- as.integer(tab_fecha_in2$Dif_dias)
tab_fecha_in2["Dias"] <- cumsum(tab_fecha_in2$Dif_dias)

datos_log <- data.frame(Dias = tab_fecha_in2$Dias, Acumulado = tab_fecha_in2$Acumulado)
datos_log <- head(datos_log, nrow(datos_log) - 3)
mod_log <- nls(Acumulado ~ SSlogis(Dias, phi1, phi2, phi3), data = datos_log)
summary(mod_log)
```

Con base en el modelo ajustado, se realiza la predicción para tres tiempos futuros, considerando de la última fecha de registro, se obtienen los valores de casos positivos detectados para los próximos 15, 30 y 45 días:
```{r eval=TRUE}
p_log1 <- max(datos_log$Dias)
p_log2 <- round(p_log1+5, -1)
p_log3 <- p_log2 + 15
p_log4 <- p_log3 + 15

pred_log <- predict(mod_log,data.frame(Dias = c(p_log1, p_log2, p_log3, p_log4)))
max_pred <-round(pred_log[4]+500,-3) 
pred_log
```
 
Los resultados tanto del modelo logístico, como de los valores predichos, se ilustran en la siguiente gráfica:
```{r eval=TRUE, fig3, fig.height = 8, fig.width = 10, fig.align = "center"}
dia1_log <- min(datos3$FECHA_INGRESO)

alpha <- coef(mod_log)  #Coeficientes
plot(Acumulado ~ Dias, data = datos_log, main = "Modelo de crecimiento logístico para SARS-Cov2 en México", 
     xlab = "Días", ylab = "Casos positivos acumulados", xlim = c(1, p_log4+15), ylim = c(1, max_pred))  #Casos
curve(alpha[1]/(1 + exp(-(x - alpha[2])/alpha[3])), add = T, col = "blue")  #Modelo
points(p_log2, pred_log[2], pch = "x", cex = 1.3)
points(p_log3, pred_log[3], pch = "x", cex = 1.3)
points(p_log4, pred_log[4], pch = "x", cex = 1.3)
text(p_log2, pred_log[2], labels = paste0(dia1_log + p_log2, '\n', "[", round(pred_log[2], -2) ," casos]"), 
     adj = c(1.1,0))
text(p_log3, pred_log[3], labels = paste0(dia1_log + p_log3, '\n', "[", round(pred_log[3], -2) ," casos]"), 
     adj = c(1.1,0))
text(p_log4, pred_log[4], labels = paste0(dia1_log + p_log4, '\n', "[", round(pred_log[4], -2) ," casos]"), 
     pos = 1, offset = 0.8)
```

### Defunciones de casos positivos SARS-CoV2 registradas por fecha
En las siguientes gráficas podemos apreciar el número de muertes por día (A), así como el acumulado del periodo total (B), tomado como referencia la fecha de defunción *[FECHA_DEF]* de los pacientes diagnosticados con SARS-CoV2:
```{r eval=TRUE, fig4, fig.height = 5, fig.width = 10, fig.align = "center"}
tab_fecha_def <- count(datos3, Fecha = datos3$FECHA_DEF)
#tab_fecha_def <- rbind(data.frame(Fecha = as.Date(dia1_log), n = 0),tab_fecha_def) #Fecha inicial = casos positivos
tab_fecha_def<- head(tab_fecha_def, nrow(tab_fecha_def) - 1)
tab_fecha_def["Acumulado"] <- cumsum(tab_fecha_def$n)
mortalidad <- round(((sum(tab_fecha_def$n) * 100) / 
                       tab_resultado$n[which(tab_resultado$Resultado == "Positivo SARS-CoV-2")]),1)

g_sum_def <- ggbarplot(tab_fecha_def, x = "Fecha", y = "n",
                   fill = "steelblue", color = "black",)
g_acum_def <- ggline(tab_fecha_def, x = "Fecha", y = "Acumulado",
                 color = "steelblue", point.color = "black", point.size = 0.2) +
  scale_y_continuous(labels=function(x) format(x, big.mark = ",", scientific = FALSE))

ggarrange(g_sum_def, g_acum_def, labels = c("A)", "B)"), ncol = 2, nrow = 1)
```

#### Modelo de crecimiento logístico de defunciones registradas
En consideración de estos datos, tenemos que **al día `r first(datos$FECHA_ACTUALIZACION)` se cuentan con `r format(sum(tab_fecha_def$n),big.mark=",")` defunciones de personas diagnosticadas con SARS-CoV2 (tasa de mortalidad de `r mortalidad`%)**, en ese sentido, también se realiza un ajuste de estos datos a una función logística, e igualmente predecir los valores de defunciones en los próximos 45 días. Para tal efecto, se omiten los últimos tres días de registro, los cuales probablemente no cuenten con los valores de detección reales y tenga como efecto la formación de una falsa asíntota:
```{r eval=TRUE}
tab_fecha_def2 <- tab_fecha_def %>% mutate(Dif_dias = difftime(tab_fecha_def$Fecha, lag(tab_fecha_def$Fecha,1)))
tab_fecha_def2$Dif_dias <- replace_na(tab_fecha_def2$Dif_dias,1)
tab_fecha_def2$Dif_dias <- as.integer(tab_fecha_def2$Dif_dias)
tab_fecha_def2["Dias"] <- cumsum(tab_fecha_def2$Dif_dias)

datos_def_log <- data.frame(Dias = tab_fecha_def2$Dias, Acumulado = tab_fecha_def2$Acumulado)
datos_def_log <- head(datos_def_log, nrow(datos_def_log) - 3)
mod_def_log <- nls(Acumulado ~ SSlogis(Dias, phi1, phi2, phi3), data = datos_def_log)
summary(mod_def_log)
```

Con base en el modelo ajustado, se realiza la predicción para tres tiempos futuros, considerando de la última fecha de registro, se obtienen los valores de casos positivos detectados para los próximos 15, 30 y 45 días:
```{r eval=TRUE}
p_def_log1 <- max(datos_def_log$Dias)
p_def_log2 <- round(p_def_log1+5, -1)
p_def_log3 <- p_def_log2 + 15
p_def_log4 <- p_def_log3 + 15

pred_def_log <- predict(mod_def_log,data.frame(Dias = c(p_def_log1, p_def_log2, p_def_log3, p_def_log4)))
max_pred_def <-round(pred_def_log[4]+150,-2) 
pred_def_log
```

Los resultados tanto del modelo logístico, como de los valores predichos, se ilustran en la siguiente gráfica:
```{r eval=TRUE, fig5, fig.height = 8, fig.width = 10, fig.align = "center"}
dia1_def_log <- min(tab_fecha_def$Fecha)

alpha2 <- coef(mod_def_log)  #Coeficientes
plot(Acumulado ~ Dias, data = datos_def_log, main = "Modelo de crecimiento logístico para defunciones por SARS-Cov2", 
     xlab = "Días", ylab = "Defunciones acumuladas", xlim = c(1, p_def_log4+15), ylim = c(1, max_pred_def))  #Casos
curve(alpha2[1]/(1 + exp(-(x - alpha2[2])/alpha2[3])), add = T, col = "blue")  #Modelo
points(p_def_log2, pred_def_log[2], pch = "x", cex = 1.3)
points(p_def_log3, pred_def_log[3], pch = "x", cex = 1.3)
points(p_def_log4, pred_def_log[4], pch = "x", cex = 1.3)
text(p_def_log2, pred_def_log[2], labels = paste0(dia1_def_log + p_def_log2, '\n', "[", round(pred_def_log[2], -1) ," defunciones]"), 
     adj = c(1.1,0))
text(p_def_log3, pred_def_log[3], labels = paste0(dia1_def_log + p_def_log3, '\n', "[", round(pred_def_log[3], -1) ," defunciones]"), 
     pos = 3, offset = 0.8)
text(p_def_log4, pred_def_log[4], labels = paste0(dia1_def_log + p_def_log4, '\n', "[", round(pred_def_log[4], -1) ," defunciones]"), 
     pos = 1, offset = 0.8)
```

#### Tasa de mortalidad por SARS-CoV2
Bajo esta misma tesitura, tenemos que **al día `r first(datos$FECHA_ACTUALIZACION)` se cuentan con una tasa de mortalidad de `r mortalidad`%**, en ese sentido, en las siguiente figura tenemos en la gráfica A) los cambios en la tasa de mortalidad en relación al tiempo transcurrido desde la primer defunción, y en la gráfica B) la relación entre la tasa de mortalidad y los casos positivos de SARS-CoV2 registrados por día:
```{r eval=TRUE, fig6, fig.height = 5, fig.width = 10, fig.align = "center", results='hide', message=FALSE, warning=FALSE}
tab_mortalidad <- inner_join(tab_fecha_def,tab_fecha_in, by = c("Fecha" = "Fecha"))
tab_mortalidad["Mortalidad"] <- round((tab_mortalidad$Acumulado.x * 100) / tab_mortalidad$Acumulado.y, 2)
tab_mortalidad <- head(tab_mortalidad, nrow(tab_mortalidad) - 5)

g_mort1 <- ggline(tab_mortalidad, x = "Fecha", y = "Mortalidad",
                  color = "steelblue", point.color = "black", point.size = 0.2)
g_mort2 <- ggscatter(tab_mortalidad, x = "n.y", y = "Mortalidad", xlab = "Casos +SARS-CoV2 por día",
                     add = "loess", conf.int = TRUE)

ggarrange(g_mort1, g_mort2, labels = c("A)", "B)"), ncol = 2, nrow = 1)
```


### Comorbilidad en los casos de SARS-CoV2
En la información provista por la Dirección General de Epidemiología también se reportan algunos datos de comorbilidad, entendida ésta última como la presencia de uno o más trastornos (o enfermedades) además de la enfermedad o trastorno primario, en este caso el SARS-Cov2.  

A continuación se presentan una serie de tablas donde se incorporan estos datos, expresados por la suma total de casos, así como su porcentaje relativo al total de presencia o ausencia del trastorno secundario (solo se incluye código para el primer dato):  

#### Diabetes:
La diabetes mellitus (DM) es un conjunto de trastornos metabólicos, cuya característica común principal es la presencia de concentraciones elevadas de glucosa en la sangre de manera persistente o crónica, debido ya sea a un defecto en la producción de insulina, a una resistencia a la acción de ella para utilizar la glucosa, a un aumento en la producción de glucosa o a una combinación de estas causas.
```{r results = 'asis'}
morb_diab <- filter(datos2, RESULTADO %in% c("No positivo SARS-CoV-2","Positivo SARS-CoV-2") & 
                       DIABETES %in% c("NO","SI"))
morb_diab <- group_by(morb_diab, DIABETES, RESULTADO)
morb_diab <- summarise(morb_diab, suma = sum(Num))

morb_diab_t <- dcast(morb_diab, RESULTADO ~ DIABETES, value.var = "suma")
morb_diab_t["No"] <- paste0(round(morb_diab_t$NO*100 / sum(morb_diab_t$NO),1)," %")
morb_diab_t["Si"] <- paste0(round(morb_diab_t$SI*100 / sum(morb_diab_t$SI),1)," %") 

kable(morb_diab_t, format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "center") %>%
  add_header_above(c(" " = 1, "Total" = 2, "Porcentaje" = 2))
```

#### Asma:
El asma es una enfermedad del sistema respiratorio caracterizada por una inflamación crónica de la vía aérea, cuyas manifestaciones clínicas son heterogéneas y variables en el tiempo y consisten en sibilancias, dificultad respiratoria, opresión torácica y tos.
```{r results = 'asis', echo = FALSE}
morb_asma <- filter(datos2, RESULTADO %in% c("No positivo SARS-CoV-2","Positivo SARS-CoV-2") & 
                       ASMA %in% c("NO","SI"))
morb_asma <- group_by(morb_asma, ASMA, RESULTADO)
morb_asma <- summarise(morb_asma, suma = sum(Num))

morb_asma_t <- dcast(morb_asma, RESULTADO ~ ASMA, value.var = "suma")
morb_asma_t["No"] <- paste0(round(morb_asma_t$NO*100 / sum(morb_asma_t$NO),1)," %")
morb_asma_t["Si"] <- paste0(round(morb_asma_t$SI*100 / sum(morb_asma_t$SI),1)," %") 

kable(morb_asma_t, format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "center") %>%
  add_header_above(c(" " = 1, "Total" = 2, "Porcentaje" = 2))
```

#### Inmunosupresión:
La inmunosupresión se define como la inhibición de uno o más componentes del sistema inmunitario adaptativo o innato (la inflamación), que puede producirse como resultado de una enfermedad subyacente o de forma intencional mediante el uso de medicamentos (llamados inmunosupresores) u otros tratamientos, como radiación o cirugía (ablación del bazo), con el propósito de prevenir o tratar el rechazo de un trasplante o una enfermedad autoinmune.
```{r results = 'asis', echo = FALSE}
morb_inmu <- filter(datos2, RESULTADO %in% c("No positivo SARS-CoV-2","Positivo SARS-CoV-2") & 
                       INMUSUPR %in% c("NO","SI"))
morb_inmu <- group_by(morb_inmu, INMUSUPR, RESULTADO)
morb_inmu <- summarise(morb_inmu, suma = sum(Num))

morb_inmu_t <- dcast(morb_inmu, RESULTADO ~ INMUSUPR, value.var = "suma")
morb_inmu_t["No"] <- paste0(round(morb_inmu_t$NO*100 / sum(morb_inmu_t$NO),1)," %")
morb_inmu_t["Si"] <- paste0(round(morb_inmu_t$SI*100 / sum(morb_inmu_t$SI),1)," %") 

kable(morb_inmu_t, format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "center") %>%
  add_header_above(c(" " = 1, "Total" = 2, "Porcentaje" = 2))
```

#### Hipertensión:
La hipertensión arterial (HTA) es una enfermedad crónica caracterizada por un incremento continuo de las cifras de la presión sanguínea por arriba de los límites sobre los cuales aumenta el riesgo cardiovascular. 
```{r results = 'asis', echo = FALSE}
morb_hipe <- filter(datos2, RESULTADO %in% c("No positivo SARS-CoV-2","Positivo SARS-CoV-2") & 
                       HIPERTENSION %in% c("NO","SI"))
morb_hipe <- group_by(morb_hipe, HIPERTENSION, RESULTADO)
morb_hipe <- summarise(morb_hipe, suma = sum(Num))

morb_hipe_t <- dcast(morb_hipe, RESULTADO ~ HIPERTENSION, value.var = "suma")
morb_hipe_t["No"] <- paste0(round(morb_hipe_t$NO*100 / sum(morb_hipe_t$NO),1)," %")
morb_hipe_t["Si"] <- paste0(round(morb_hipe_t$SI*100 / sum(morb_hipe_t$SI),1)," %") 

kable(morb_hipe_t, format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "center") %>%
  add_header_above(c(" " = 1, "Total" = 2, "Porcentaje" = 2))
```

#### Enfermedad cardiovascular:
El término enfermedades cardiovasculares es usado para referirse a todo tipo de enfermedad de las arterias coronarias, que son relacionadas con el corazón o los vasos sanguíneos, (arterias y venas). Este término describe cualquier enfermedad que afecte al sistema cardiovascular (usado en MeSH), es utilizado comúnmente para referirse a aquellos relacionados con la arteriosclerosis (enfermedades en las arterias).
```{r results = 'asis', echo = FALSE}
morb_card <- filter(datos2, RESULTADO %in% c("No positivo SARS-CoV-2","Positivo SARS-CoV-2") & 
                       CARDIOVASCULAR %in% c("NO","SI"))
morb_card <- group_by(morb_card, CARDIOVASCULAR, RESULTADO)
morb_card <- summarise(morb_card, suma = sum(Num))

morb_card_t <- dcast(morb_card, RESULTADO ~ CARDIOVASCULAR, value.var = "suma")
morb_card_t["No"] <- paste0(round(morb_card_t$NO*100 / sum(morb_card_t$NO),1)," %")
morb_card_t["Si"] <- paste0(round(morb_card_t$SI*100 / sum(morb_card_t$SI),1)," %") 

kable(morb_card_t, format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "center") %>%
  add_header_above(c(" " = 1, "Total" = 2, "Porcentaje" = 2))
```

#### Obesidad:
La obesidad se caracteriza por acumulación excesiva de grasa o hipertrofia general del tejido adiposo en el cuerpo; es decir, cuando la reserva natural de energía de los humanos y otros mamíferos —almacenada en forma de grasa corporal— se incrementa hasta un punto en que pone en riesgo la salud o la vida. 
```{r results = 'asis', echo = FALSE}
morb_obes <- filter(datos2, RESULTADO %in% c("No positivo SARS-CoV-2","Positivo SARS-CoV-2") & 
                       OBESIDAD %in% c("NO","SI"))
morb_obes <- group_by(morb_obes, OBESIDAD, RESULTADO)
morb_obes <- summarise(morb_obes, suma = sum(Num))

morb_obes_t <- dcast(morb_obes, RESULTADO ~ OBESIDAD, value.var = "suma")
morb_obes_t["No"] <- paste0(round(morb_obes_t$NO*100 / sum(morb_obes_t$NO),1)," %")
morb_obes_t["Si"] <- paste0(round(morb_obes_t$SI*100 / sum(morb_obes_t$SI),1)," %") 

kable(morb_obes_t, format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "center") %>%
  add_header_above(c(" " = 1, "Total" = 2, "Porcentaje" = 2))
```

#### Enfermedad renal crónica:
La enfermedad renal crónica (ERC) o insuficiencia renal crónica (IRC) es una pérdida progresiva (por tres meses o más) e irreversible de las funciones renales. Como consecuencia, los riñones pierden su capacidad para eliminar desechos, concentrar la orina y conservar los electrolitos en la sangre.
```{r results = 'asis', echo = FALSE}
morb_renal <- filter(datos2, RESULTADO %in% c("No positivo SARS-CoV-2","Positivo SARS-CoV-2") & 
                       RENAL_CRONICA %in% c("NO","SI"))
morb_renal <- group_by(morb_renal, RENAL_CRONICA, RESULTADO)
morb_renal <- summarise(morb_renal, suma = sum(Num))

morb_renal_t <- dcast(morb_renal, RESULTADO ~ RENAL_CRONICA, value.var = "suma")
morb_renal_t["No"] <- paste0(round(morb_renal_t$NO*100 / sum(morb_renal_t$NO),1)," %")
morb_renal_t["Si"] <- paste0(round(morb_renal_t$SI*100 / sum(morb_renal_t$SI),1)," %") 

kable(morb_renal_t, format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "center") %>%
  add_header_above(c(" " = 1, "Total" = 2, "Porcentaje" = 2))
```

#### Tabaquismo:
El tabaquismo es la adicción al tabaco fumado, provocada principalmente por uno de sus componentes más activos: la nicotina. El consumo habitual de tabaco produce enfermedades nocivas para la salud de la persona que lo consume. 
```{r results = 'asis', echo = FALSE}
morb_tabaq <- filter(datos2, RESULTADO %in% c("No positivo SARS-CoV-2","Positivo SARS-CoV-2") & 
                       TABAQUISMO %in% c("NO","SI"))
morb_tabaq <- group_by(morb_tabaq, TABAQUISMO, RESULTADO)
morb_tabaq <- summarise(morb_tabaq, suma = sum(Num))

morb_tabaq_t <- dcast(morb_tabaq, RESULTADO ~ TABAQUISMO, value.var = "suma")
morb_tabaq_t["No"] <- paste0(round(morb_tabaq_t$NO*100 / sum(morb_tabaq_t$NO),1)," %")
morb_tabaq_t["Si"] <- paste0(round(morb_tabaq_t$SI*100 / sum(morb_tabaq_t$SI),1)," %") 

kable(morb_tabaq_t, format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "center") %>%
  add_header_above(c(" " = 1, "Total" = 2, "Porcentaje" = 2))
```

# Distribución espacial de los casos
Un aspecto fundamental de los datos reportados de SARS-Cov2 es su espacialidad, es decir, como es la distribución de estos datos en la geografía del país. En este sentido, se realizan unos ejercicios básicos de cartografía en R, para lo cual se realiza una preparación de los datos espaciales, que de manera general se resume en la integración de la información de casos reportados al marco geoestadístico nacional (estatal y municipal) para poder realizar los mapas consecuentes:
```{r eval=TRUE}
s_mun <- st_read("SHP/municipios_2015.shp")
s_ent <- st_read("SHP/estados_2015.shp")
casos_mun <- count(datos3, CVEMUN = datos3$MUNICIPIO_RES)
casos_ent <- count(datos3, CVE_ENT = datos3$ENTIDAD_RES)
s_ent$CVE_ENT <- as.factor(d_entidad[[s_ent$CVE_ENT]])

geo_ent <- left_join(s_ent, casos_ent)
geo_ent$Casos_100k <- (geo_ent$n/geo_ent$pob_tot)*100000
geo_ent$Casos_km2 <- (geo_ent$n/geo_ent$sup_km2)

geo_mun <- left_join(s_mun, casos_mun)
geo_mun$Casos_100k <- (geo_mun$n/geo_mun$pob_tot)*100000
geo_mun$Casos_km2 <- (geo_mun$n/geo_mun$sup_km2)
```

Como se puede apreciar, se generan dos variables mas con base en los diagnósticos positivos de SARS-CoV2:  

* Casos por cada 100 mil habitantes.  
* Casos por kilómetro cuadrado.  

Lo anterior con miras de tener información comparable entre las diferentes demarcaciones, sin caer en sesgos por la diferencia entre la superficie y población total de dichas entidades.  

### República mexicana
En el siguiente mapa se ilustra la distribución de los los casos positivos por cada 100 mil habitantes en las entidades federativas (estados) de México:
```{r eval=TRUE, fig7, fig.height = 8, fig.width = 10, fig.align = "center"}
tmap_mode("plot")
mapa_mex <- tm_shape(geo_ent) + 
   tm_polygons("Casos_100k", id = "CVE_ENT", palette = c("#FFF0EB", "#C88F00", "#640C00"), 
               style = "jenks", colorNA = "#EAEAEA", textNA = "Sin casos", 
               title = "Casos por cada \n100k habitantes") + 
   tm_compass() + tm_scale_bar() + tm_grid(n.x = 3, n.y = 4)
mapa_mex
```

Y en la siguiente gráfica los mismo valores de casos positivos por cada 100 mil habitantes para cada entidad federativa, organizados de mayor a menor:
```{r eval=TRUE, fig8, fig.height = 10, fig.width = 8, fig.align = "center"}
g_ent_100k <- ggdotchart(geo_ent, x = "CVE_ENT", y = "Casos_100k", color = "steelblue", sorting = "descending", 
                         add = "segments", add.params = list(color = "lightgray", size = 2), rotate = TRUE, 
                         dot.size = 8, label = round(geo_ent$Casos_100k), 
                         font.label = list(face = "bold", color = "white", size = 10, vjust = 0.5), 
                         ylab = "Casos por cada 100 mil habitantes", xlab = "Entidad", ggtheme = theme_pubr())
g_ent_100k
```

### Mapas por entidad federativa {.tabset .tabset-fade}

#### Ciudad de México (CDMX)
```{r eval=TRUE, fig9, fig.height = 10, fig.width = 8, fig.align = "center"}
tmap_mode("plot")
geo_cdmx <- filter(geo_mun, AREAS_GE_2 == "09")
mapa_cdmx <- tm_shape(geo_cdmx) + 
   tm_polygons("Casos_km2", id = "CVEMUN", palette = c("#FFFF99", "#FFCC00", "#720606"), 
               n = 5, style = "pretty", colorNA = "#EAEAEA", textNA = "Sin casos", 
               title = "Casos por Km^2") + 
   tm_bubbles("n", col = "Casos_100k", border.col = "black", border.alpha = .5,
              n = 5, style = "pretty", colorNA = "#EAEAEA", textNA = "Sin casos",
              palette="-RdYlBu", contrast=1, scale = 3, title.size="Casos totales", 
              title.col="Casos por cada \n100k habitantes", id="CVEMUN") + 
   tm_compass() + tm_scale_bar() + tm_grid(n.x = 3, n.y = 4)
mapa_cdmx
```

#### Estado de México (MEX)
```{r eval=TRUE, fig10, fig.height = 8, fig.width = 8, fig.align = "center", results='hide', message=FALSE, warning=FALSE}
tmap_mode("plot")
geo_edomex <- filter(geo_mun, AREAS_GE_2 == "15")
mapa_edomex <- tm_shape(geo_edomex) + 
   tm_polygons("Casos_km2", id = "CVEMUN", palette = c("#FFFF99", "#FFCC00", "#720606"), 
               n = 5, style = "jenks", colorNA = "#EAEAEA", textNA = "Sin casos", 
               title = "Casos por Km^2") + 
   tm_bubbles("n", col = "Casos_100k", border.col = "black", border.alpha = .5,
              n = 5, style = "jenks", colorNA = "#EAEAEA", textNA = "Sin casos",
              palette = c("#003399", "#FFFF00", "#FF3300"), contrast=1, scale = 2, title.size="Casos totales", 
              title.col="Casos por cada \n100k habitantes", id="CVEMUN") + 
   tm_compass() + tm_scale_bar() + tm_grid(n.x = 3, n.y = 4)
mapa_edomex
```

#### Jalisco (JAL)
```{r eval=TRUE, fig11, fig.height = 8, fig.width = 8, fig.align = "center", results='hide', message=FALSE, warning=FALSE}
tmap_mode("plot")
geo_jal <- filter(geo_mun, AREAS_GE_2 == "14")
mapa_jal <- tm_shape(geo_jal) + 
   tm_polygons("Casos_km2", id = "CVEMUN", palette = c("#FFFF99", "#FFCC00", "#720606"), 
               n = 5, style = "bclust", colorNA = "#EAEAEA", textNA = "Sin casos", 
               title = "Casos por Km^2") + 
   tm_bubbles("n", col = "Casos_100k", border.col = "black", border.alpha = .5,
              n = 5, style = "jenks", colorNA = "#EAEAEA", textNA = "Sin casos",
              palette = c("#003399", "#FFFF00", "#FF3300"), contrast=1, scale = 1, title.size="Casos totales", 
              title.col="Casos por cada \n100k habitantes", id="CVEMUN") + 
   tm_compass() + tm_scale_bar() + tm_grid(n.x = 3, n.y = 4)
mapa_jal
```

#### Sonora (SON)
```{r eval=TRUE, fig12, fig.height = 8, fig.width = 8, fig.align = "center", results='hide', message=FALSE, warning=FALSE}
tmap_mode("plot")
geo_son <- filter(geo_mun, AREAS_GE_2 == "26")
mapa_son <- tm_shape(geo_son) + 
   tm_polygons("Casos_km2", id = "CVEMUN", palette = c("#FFFF99", "#FFCC00", "#720606"), 
               n = 5, style = "jenks", colorNA = "#EAEAEA", textNA = "Sin casos", 
               title = "Casos por Km^2") + 
   tm_bubbles("n", col = "Casos_100k", border.col = "black", border.alpha = .5,
              n = 5, style = "jenks", colorNA = "#EAEAEA", textNA = "Sin casos",
              palette = c("#003399", "#FFFF00", "#FF3300"), contrast=1, scale = 2, title.size="Casos totales", 
              title.col="Casos por cada \n100k habitantes", id="CVEMUN") + 
   tm_compass() + tm_scale_bar() + tm_grid(n.x = 3, n.y = 4)
mapa_son
```

#### Quintana Roo (ROO)
```{r eval=TRUE, fig13, fig.height = 10, fig.width = 8, fig.align = "center", results='hide', message=FALSE, warning=FALSE}
tmap_mode("plot")
geo_roo <- filter(geo_mun, AREAS_GE_2 == "23")
mapa_roo <- tm_shape(geo_roo) + 
   tm_polygons("Casos_km2", id = "CVEMUN", palette = c("#FFFF99", "#FFCC00", "#720606"), 
               n = 5, style = "jenks", colorNA = "#EAEAEA", textNA = "Sin casos", 
               title = "Casos por Km^2") + 
   tm_bubbles("n", col = "Casos_100k", border.col = "black", border.alpha = .5,
              n = 5, style = "jenks", colorNA = "#EAEAEA", textNA = "Sin casos",
              palette = c("#003399", "#FFFF00", "#FF3300"), contrast=1, scale = 2, title.size="Casos totales", 
              title.col="Casos por cada \n100k habitantes", id="CVEMUN") + 
   tm_compass() + tm_scale_bar() + tm_grid(n.x = 3, n.y = 4)
mapa_roo
```

Continuara...